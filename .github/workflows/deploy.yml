name: Build and Deploy to Hostinger

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
        env:
          VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
          VITE_OPENAI_API_KEY: ${{ secrets.VITE_OPENAI_API_KEY }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      
      - name: Deploy to Hostinger via LFTP
        run: |
          sudo apt-get install -y --no-install-recommends lftp || (sudo apt-get update && sudo apt-get install -y --no-install-recommends lftp)
          # LFTP command explanation:
          # -u: username,password
          # -e: execute command
          # set ssl:verify-certificate no: prevent self-signed cert errors
          # set ftp:ssl-allow yes: allow SSL (try explicit FTPS)
          # mirror -R: reverse mirror (upload)
          # --parallel=2: use 2 parallel connections for speed
          # --verbose: show progress
          # --exclude-glob: exclude git and node_modules
                   set net:timeout 180; 
                   set net:max-retries 5; 
                   set net:reconnect-interval-base 5; 
                   set net:connection-limit 1;
                   set ftp:ssl-allow yes;
                   open -u ${{ secrets.FTP_USER }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_HOST }}; 
                   mirror -R --verbose --no-perms --only-newer --parallel=1 --delete --exclude-glob .git* --exclude-glob node_modules ./dist/ /home/u250946921/domains/healthaxisinventory.com/public_html/"
